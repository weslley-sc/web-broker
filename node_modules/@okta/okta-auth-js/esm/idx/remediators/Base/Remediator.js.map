{"version":3,"sources":["../../../../../lib/idx/remediators/Base/Remediator.ts"],"names":["AuthSdkError","getAllValues","getRequiredValues","titleCase","Remediator","constructor","remediation","values","authenticators","map","authenticator","type","getName","name","canRemediate","required","needed","find","key","hasData","getData","allValues","res","reduce","data","value","entry","i","length","val","Object","keys","getNextStep","getRelatesToType","inputs","getInputs","inputFromRemediation","item","input","aliases","includes","Array","isArray","forEach","push","getMessages","form","messages","field","getValuesAfterProceed","authenticatorType","filter","relatesTo"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGA;AACA,SAASA,YAAT,QAA6B,iBAA7B;AAGA,SAASC,YAAT,EAAuBC,iBAAvB,EAA0CC,SAA1C,QAA2D,SAA3D,C,CAEA;;AAQA;AACA,OAAO,MAAMC,UAAN,CAAiB;AAOtBC,EAAAA,WAAW,CAACC,WAAD,EAA8D;AAAA;;AAAA,QAAhCC,MAAgC,uEAAJ,EAAI;AACvE;AACAA,IAAAA,MAAM,CAACC,cAAP,GAAyB,0BAAAD,MAAM,CAACC,cAAP,gFAAuBC,GAAvB,CAA2BC,aAAa,IAAI;AACnE,aAAO,OAAOA,aAAP,KAAyB,QAAzB,GACH;AAAEC,QAAAA,IAAI,EAAED;AAAR,OADG,GACuBA,aAD9B;AAED,KAHwB,MAGnB,EAHN,CAFuE,CAOvE;;AACA,SAAKH,MAAL,GAAcA,MAAd;AACA,SAAKD,WAAL,GAAmBA,WAAnB;AACD;;AAEDM,EAAAA,OAAO,GAAW;AAChB,WAAO,KAAKN,WAAL,CAAiBO,IAAxB;AACD,GArBqB,CAuBtB;;;AACAC,EAAAA,YAAY,GAAY;AACtB,QAAI,CAAC,KAAKL,GAAV,EAAe;AACb,aAAO,KAAP;AACD;;AACD,QAAMM,QAAQ,GAAGb,iBAAiB,CAAC,KAAKI,WAAN,CAAlC;AACA,QAAMU,MAAM,GAAGD,QAAQ,CAACE,IAAT,CAAeC,GAAD,IAAS,CAAC,KAAKC,OAAL,CAAaD,GAAb,CAAxB,CAAf;;AACA,QAAIF,MAAJ,EAAY;AACV,aAAO,KAAP,CADU,CACI;AACf;;AACD,WAAO,IAAP,CATsB,CAST;AACd,GAlCqB,CAoCtB;;;AACAI,EAAAA,OAAO,CAACF,GAAD,EAAe;AAEpB,QAAI,CAACA,GAAL,EAAU;AACR,UAAIG,SAAS,GAAGpB,YAAY,CAAC,KAAKK,WAAN,CAA5B;AACA,UAAIgB,GAAG,GAAGD,SAAS,CAACE,MAAV,CAAiB,CAACC,IAAD,EAAON,GAAP,KAAe;AACxCM,QAAAA,IAAI,CAACN,GAAD,CAAJ,GAAY,KAAKE,OAAL,CAAaF,GAAb,CAAZ,CADwC,CACT;;AAC/B,eAAOM,IAAP;AACD,OAHS,EAGP,EAHO,CAAV;AAIA,aAAOF,GAAP;AACD,KATmB,CAWpB;;;AACA,QAAI,OAAO,kBAAWnB,SAAS,CAACe,GAAD,CAApB,EAAP,KAAwC,UAA5C,EAAwD;AACtD,aAAO,kBAAWf,SAAS,CAACe,GAAD,CAApB,GACL,KAAKZ,WAAL,CAAiBmB,KAAjB,CAAuBR,IAAvB,CAA4B;AAAA,YAAC;AAACJ,UAAAA;AAAD,SAAD;AAAA,eAAYA,IAAI,KAAKK,GAArB;AAAA,OAA5B,CADK,CAAP;AAGD;;AAED,QAAI,CAAC,KAAKT,GAAV,EAAe;AACb,aAAO,KAAKF,MAAL,CAAYW,GAAZ,CAAP;AACD,KApBmB,CAsBpB;;;AACA,QAAMQ,KAAK,GAAG,KAAKjB,GAAL,CAASS,GAAT,CAAd;;AACA,QAAI,CAACQ,KAAL,EAAY;AACV,aAAO,KAAKnB,MAAL,CAAYW,GAAZ,CAAP;AACD,KA1BmB,CA4BpB;;;AACA,SAAK,IAAIS,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGD,KAAK,CAACE,MAA1B,EAAkCD,CAAC,EAAnC,EAAuC;AACrC,UAAIE,GAAG,GAAG,KAAKtB,MAAL,CAAYmB,KAAK,CAACC,CAAD,CAAjB,CAAV;;AACA,UAAIE,GAAJ,EAAS;AACP,eAAOA,GAAP;AACD;AACF;AACF;;AAEDV,EAAAA,OAAO,CACLD,GADK,EAGP;AACE;AAEA;AACA,QAAMM,IAAI,GAAG,KAAKJ,OAAL,CAAaF,GAAb,CAAb;;AACA,QAAI,OAAOM,IAAP,KAAgB,QAApB,EAA8B;AAC5B,aAAO,CAAC,CAACM,MAAM,CAACC,IAAP,CAAYP,IAAZ,EAAkBP,IAAlB,CAAuBC,GAAG,IAAI,CAAC,CAACM,IAAI,CAACN,GAAD,CAApC,CAAT;AACD;;AACD,WAAO,CAAC,CAACM,IAAT;AACD;;AAEDQ,EAAAA,WAAW,GAAa;AACtB,QAAMnB,IAAI,GAAG,KAAKD,OAAL,EAAb;AACA,QAAMD,IAAI,GAAG,KAAKsB,gBAAL,EAAb;AACA,QAAMC,MAAM,GAAG,KAAKC,SAAL,EAAf;AACA;AAAStB,MAAAA,IAAT;AAAeqB,MAAAA;AAAf,OAA2BvB,IAAI,IAAI;AAAEA,MAAAA;AAAF,KAAnC;AACD,GA7FqB,CA+FtB;;;AACQwB,EAAAA,SAAS,GAAG;AAClB,QAAI,CAAC,KAAK1B,GAAV,EAAe;AACb,aAAO,EAAP;AACD;;AAED,WAAOqB,MAAM,CAACC,IAAP,CAAY,KAAKtB,GAAjB,EAAsBc,MAAtB,CAA6B,CAACW,MAAD,EAAShB,GAAT,KAAiB;AACnD,UAAMkB,oBAAoB,GAAG,KAAK9B,WAAL,CAAiBmB,KAAjB,CAAuBR,IAAvB,CAA4BoB,IAAI,IAAIA,IAAI,CAACxB,IAAL,KAAcK,GAAlD,CAA7B;;AACA,UAAI,CAACkB,oBAAL,EAA2B;AACzB,eAAOF,MAAP;AACD;;AAED,UAAII,KAAJ;AACA,UAAMC,OAAO,GAAG,KAAK9B,GAAL,CAASS,GAAT,CAAhB;AACA,UAAM;AAAEP,QAAAA;AAAF,UAAWyB,oBAAjB;;AACA,UAAI,OAAO,uBAAgBjC,SAAS,CAACe,GAAD,CAAzB,EAAP,KAA6C,UAAjD,EAA6D;AAC3DoB,QAAAA,KAAK,GAAG,uBAAgBnC,SAAS,CAACe,GAAD,CAAzB,GAAkCkB,oBAAlC,CAAR;AACD,OAFD,MAEO,IAAIzB,IAAI,KAAK,QAAb,EAAuB;AAC5B;AACA,YAAIE,IAAJ;;AACA,YAAI0B,OAAO,CAACX,MAAR,KAAmB,CAAvB,EAA0B;AACxBf,UAAAA,IAAI,GAAG0B,OAAO,CAAC,CAAD,CAAd;AACD,SAFD,MAEO;AACL;AACA1B,UAAAA,IAAI,GAAG0B,OAAO,CAACtB,IAAR,CAAaJ,IAAI,IAAIiB,MAAM,CAACC,IAAP,CAAY,KAAKxB,MAAjB,EAAyBiC,QAAzB,CAAkC3B,IAAlC,CAArB,CAAP;AACD;;AACD,YAAIA,IAAJ,EAAU;AACRyB,UAAAA,KAAK,mCAAQF,oBAAR;AAA8BvB,YAAAA;AAA9B,YAAL;AACD;AACF;;AAED,UAAI,CAACyB,KAAL,EAAY;AACV,cAAM,IAAItC,YAAJ,kCAA2CG,SAAS,CAACe,GAAD,CAApD,oCAAmF,KAAKN,OAAL,EAAnF,EAAN;AACD;;AAED,UAAI6B,KAAK,CAACC,OAAN,CAAcJ,KAAd,CAAJ,EAA0B;AACxBA,QAAAA,KAAK,CAACK,OAAN,CAAchB,CAAC,IAAIO,MAAM,CAACU,IAAP,CAAYjB,CAAZ,CAAnB;AACD,OAFD,MAEO;AACLO,QAAAA,MAAM,CAACU,IAAP,CAAYN,KAAZ;AACD;;AACD,aAAOJ,MAAP;AACD,KAnCM,EAmCJ,EAnCI,CAAP;AAoCD,GAzIqB,CA2ItB;;;AACAW,EAAAA,WAAW,GAA6B;AAAA;;AACtC,QAAI,CAAC,KAAKvC,WAAL,CAAiBmB,KAAtB,EAA6B;AAC3B;AACD;;AACD,oCAAO,KAAKnB,WAAL,CAAiBmB,KAAjB,CAAuB,CAAvB,CAAP,oFAAO,sBAA2BqB,IAAlC,2DAAO,uBAAiCrB,KAAjC,CAAuCF,MAAvC,CAA8C,CAACwB,QAAD,EAAWC,KAAX,KAAqB;AACxE,UAAIA,KAAK,CAACD,QAAV,EAAoB;AAClBA,QAAAA,QAAQ,GAAG,CAAC,GAAGA,QAAJ,EAAc,GAAGC,KAAK,CAACD,QAAN,CAAetB,KAAhC,CAAX;AACD;;AACD,aAAOsB,QAAP;AACD,KALM,EAKJ,EALI,CAAP;AAMD,GAtJqB,CAwJtB;AACA;;;AACAE,EAAAA,qBAAqB,GAAG;AAAA;;AACtB,QAAMC,iBAAiB,GAAG,KAAKjB,gBAAL,EAA1B;AACA,QAAMzB,cAAc,4BAAI,KAAKD,MAAL,CAAYC,cAAhB,0DAAG,sBACnB2C,MADmB,CACZzC,aAAa,IAAIA,aAAa,CAACC,IAAd,KAAuBuC,iBAD5B,CAAvB;AAEA,2CAAY,KAAK3C,MAAjB;AAAyBC,MAAAA;AAAzB;AACD;;AAESyB,EAAAA,gBAAgB,GAAG;AAAA;;AAC3B,oCAAO,KAAK3B,WAAL,CAAiB8C,SAAxB,0DAAO,sBAA4B3B,KAA5B,CAAkCd,IAAzC;AACD;;AAnKqB","sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n\n/* eslint-disable complexity */\nimport { AuthSdkError } from '../../../errors';\nimport { NextStep, IdxMessage, Authenticator } from '../../types';\nimport { IdxRemediation } from '../../types/idx-js';\nimport { getAllValues, getRequiredValues, titleCase } from '../util';\n\n// A map from IDX data values (server spec) to RemediationValues (client spec)\nexport type IdxToRemediationValueMap = Record<string, string[]>;\n\nexport interface RemediationValues {\n  stateHandle?: string;\n  authenticators?: Authenticator[] | string[];\n}\n\n// Base class - DO NOT expose static remediationName\nexport class Remediator {\n  static remediationName: string;\n\n  remediation: IdxRemediation;\n  values: RemediationValues;\n  map?: IdxToRemediationValueMap;\n\n  constructor(remediation: IdxRemediation, values: RemediationValues = {}) {\n    // map authenticators to Authenticator[] type\n    values.authenticators = (values.authenticators?.map(authenticator => {\n      return typeof authenticator === 'string' \n        ? { type: authenticator } : authenticator;\n    }) || []) as Authenticator[];\n    \n    // assign fields to the instance\n    this.values = values;\n    this.remediation = remediation;\n  }\n\n  getName(): string {\n    return this.remediation.name;\n  }\n\n  // Override this method to provide custom check\n  canRemediate(): boolean {\n    if (!this.map) {\n      return false;\n    }\n    const required = getRequiredValues(this.remediation);\n    const needed = required.find((key) => !this.hasData(key));\n    if (needed) {\n      return false; // missing data for a required field\n    }\n    return true; // all required fields have available data\n  }\n\n  // returns an object for the entire remediation form, or just a part\n  getData(key?: string) {\n\n    if (!key) {\n      let allValues = getAllValues(this.remediation);\n      let res = allValues.reduce((data, key) => {\n        data[key] = this.getData(key); // recursive\n        return data;\n      }, {});\n      return res;\n    }\n\n    // Map value by \"map${Property}\" function in each subClass\n    if (typeof this[`map${titleCase(key)}`] === 'function') {\n      return this[`map${titleCase(key)}`](\n        this.remediation.value.find(({name}) => name === key)\n      );\n    }\n\n    if (!this.map) {\n      return this.values[key];\n    }\n\n    // Handle general primitive types\n    const entry = this.map[key];\n    if (!entry) {\n      return this.values[key];\n    }\n\n    // find the first aliased property that returns a truthy value\n    for (let i = 0; i < entry.length; i++) {\n      let val = this.values[entry[i]];\n      if (val) {\n        return val;\n      }\n    }\n  }\n\n  hasData(\n    key: string // idx name\n  ): boolean \n  {\n    // no attempt to format, we want simple true/false\n\n    // First see if the remediation has a mapping for this vale\n    const data = this.getData(key);\n    if (typeof data === 'object') {\n      return !!Object.keys(data).find(key => !!data[key]);\n    }\n    return !!data;\n  }\n\n  getNextStep(): NextStep {\n    const name = this.getName();\n    const type = this.getRelatesToType();\n    const inputs = this.getInputs();\n    return { name, inputs, ...(type && { type }) };\n  }\n\n  // Get inputs for the next step\n  private getInputs() {\n    if (!this.map) {\n      return [];\n    }\n\n    return Object.keys(this.map).reduce((inputs, key) => {\n      const inputFromRemediation = this.remediation.value.find(item => item.name === key);\n      if (!inputFromRemediation) {\n        return inputs;\n      }\n\n      let input;\n      const aliases = this.map[key];\n      const { type } = inputFromRemediation;\n      if (typeof this[`getInput${titleCase(key)}`] === 'function') {\n        input = this[`getInput${titleCase(key)}`](inputFromRemediation);\n      } else if (type !== 'object') {\n        // handle general primitive types\n        let name;\n        if (aliases.length === 1) {\n          name = aliases[0];\n        } else {\n          // try find key from values\n          name = aliases.find(name => Object.keys(this.values).includes(name));\n        }\n        if (name) {\n          input = { ...inputFromRemediation, name };\n        }\n      } \n\n      if (!input) {\n        throw new AuthSdkError(`Missing custom getInput${titleCase(key)} method in Remediator: ${this.getName()}`);\n      }\n\n      if (Array.isArray(input)) {\n        input.forEach(i => inputs.push(i));\n      } else {\n        inputs.push(input);\n      }\n      return inputs;\n    }, []);\n  }\n\n  // Override this method to grab messages per remediation\n  getMessages(): IdxMessage[] | undefined {\n    if (!this.remediation.value) {\n      return;\n    }\n    return this.remediation.value[0]?.form?.value.reduce((messages, field) => {\n      if (field.messages) {\n        messages = [...messages, ...field.messages.value];\n      }\n      return messages;\n    }, []);\n  }\n\n  // Prepare values for the next remediation\n  // In general, remove finished authenticator from list\n  getValuesAfterProceed() {\n    const authenticatorType = this.getRelatesToType();\n    const authenticators = (this.values.authenticators as Authenticator[])\n      ?.filter(authenticator => authenticator.type !== authenticatorType);\n    return { ...this.values, authenticators };\n  }\n\n  protected getRelatesToType() {\n    return this.remediation.relatesTo?.value.type;\n  }\n\n}\n"],"file":"Remediator.js"}