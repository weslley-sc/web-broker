{"version":3,"sources":["../../../lib/services/TokenService.ts"],"names":["EVENT_EXPIRED","AuthSdkError","isBrowser","shouldThrottleRenew","renewTimeQueue","res","push","Date","now","length","firstTime","shift","lastTime","TokenService","constructor","tokenManager","options","start","onTokenExpiredHandler","key","autoRenew","error","emitError","renew","catch","autoRemove","remove","on","setExpireEventTimeoutAll","syncStorage","storageListener","newValue","oldValue","handleCrossTabsStorageChange","resetExpireEventTimeoutAll","emitEventsForCrossTabsStorageUpdate","storageKey","syncTimeout","setTimeout","_storageEventDelay","window","addEventListener","stop","clearExpireEventTimeoutAll","off","removeEventListener","clearTimeout"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n\n/* global window */\nimport { TokenManager, EVENT_EXPIRED } from '../TokenManager';\nimport { AuthSdkError } from '../errors';\nimport { isBrowser } from '../features';\nimport { TokenManagerOptions } from '../types';\n\nfunction shouldThrottleRenew(renewTimeQueue) {\n  let res = false;\n  renewTimeQueue.push(Date.now());\n  if (renewTimeQueue.length >= 10) {\n    // get and remove first item from queue\n    const firstTime = renewTimeQueue.shift();\n    const lastTime = renewTimeQueue[renewTimeQueue.length - 1];\n    res = lastTime - firstTime < 30 * 1000;\n  }\n  return res;\n}\n\nexport class TokenService {\n  private tokenManager: TokenManager;\n  private options: TokenManagerOptions;\n  private storageListener: (event: StorageEvent) => void;\n  private onTokenExpiredHandler: (key: string) => void;\n  private syncTimeout: unknown;\n\n  constructor(tokenManager: TokenManager, options: TokenManagerOptions = {}) {\n    this.tokenManager = tokenManager;\n    this.options = options;\n  }\n\n  start() {\n    const renewTimeQueue = [];\n    this.onTokenExpiredHandler = (key) => {\n      if (this.options.autoRenew) {\n        if (shouldThrottleRenew(renewTimeQueue)) {\n          const error = new AuthSdkError('Too many token renew requests');\n          this.tokenManager.emitError(error);\n        } else {\n          this.tokenManager.renew(key).catch(() => {}); // Renew errors will emit an \"error\" event \n        }\n      } else if (this.options.autoRemove) {\n        this.tokenManager.remove(key);\n      }\n    };\n    this.tokenManager.on(EVENT_EXPIRED, this.onTokenExpiredHandler);\n\n    this.tokenManager.setExpireEventTimeoutAll();\n\n    if (this.options.syncStorage && isBrowser()) {\n      // Sync authState cross multiple tabs when localStorage is used as the storageProvider\n      // A StorageEvent is sent to a window when a storage area it has access to is changed \n      // within the context of another document.\n      // https://developer.mozilla.org/en-US/docs/Web/API/StorageEvent\n\n      this.storageListener = ({ key, newValue, oldValue }: StorageEvent) => {\n        const handleCrossTabsStorageChange = () => {\n          this.tokenManager.resetExpireEventTimeoutAll();\n          this.tokenManager.emitEventsForCrossTabsStorageUpdate(newValue, oldValue);\n        };\n\n        // Skip if:\n        // not from localStorage.clear (event.key is null)\n        // event.key is not the storageKey\n        // oldValue === newValue\n        if (key && (key !== this.options.storageKey || newValue === oldValue)) {\n          return;\n        }\n\n        // LocalStorage cross tabs update is not synced in IE, set a 1s timer by default to read latest value\n        // https://stackoverflow.com/questions/24077117/localstorage-in-win8-1-ie11-does-not-synchronize\n        this.syncTimeout = setTimeout(() => handleCrossTabsStorageChange(), this.options._storageEventDelay);\n      };\n\n      window.addEventListener('storage', this.storageListener);\n    }\n  }\n\n  stop() {\n    this.tokenManager.clearExpireEventTimeoutAll();\n    this.tokenManager.off(EVENT_EXPIRED, this.onTokenExpiredHandler);\n    if (this.options.syncStorage && isBrowser()) {\n      window.removeEventListener('storage', this.storageListener);\n      clearTimeout(this.syncTimeout as any);\n    }\n  }\n}"],"file":"TokenService.js"}