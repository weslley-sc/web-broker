{"version":3,"file":"okta-vue.cjs.js","sources":["../../src/okta-vue.ts","../../src/components/LoginCallback.vue"],"sourcesContent":["/*!\n * Copyright (c) 2017-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { App } from 'vue'\nimport { Router, RouteLocationNormalized } from 'vue-router'\nimport { AuthSdkError, OktaAuth, AuthState, toRelativeUrl } from '@okta/okta-auth-js'\nimport { OktaVueOptions, OnAuthRequiredFunction } from './types'\n\n// constants are defined in webpack.config.js\ndeclare const PACKAGE: {\n  name: string;\n  version: string;\n}\n\nlet _oktaAuth: OktaAuth\nlet _onAuthRequired: OnAuthRequiredFunction\nlet _router: Router\nlet originalUriTracker: string\n\nconst guardSecureRoute = async (authState: AuthState) => {\n  if (!authState.isAuthenticated) {\n    _oktaAuth.setOriginalUri(originalUriTracker)\n    if (_onAuthRequired) {\n      await _onAuthRequired(_oktaAuth)\n    } else {\n      await _oktaAuth.signInWithRedirect()\n    }\n  }\n}\n\nexport const navigationGuard = async (to: RouteLocationNormalized) => {\n  // clear any subscribed guardSecureRoute\n  _oktaAuth.authStateManager.unsubscribe(guardSecureRoute)\n\n  if (to.matched.some(record => record.meta.requiresAuth)) {\n    // track the originalUri for guardSecureRoute\n    originalUriTracker = to.fullPath\n\n    // subscribe to authState change to protect secure routes when authState change\n    // all secure routes should subscribe before enter the route\n    _oktaAuth.authStateManager.subscribe(guardSecureRoute)\n\n    // guard the secure route based on the authState when enter\n    const isAuthenticated = await _oktaAuth.isAuthenticated()\n    if (!isAuthenticated) {\n      const authState = _oktaAuth.authStateManager.getAuthState()\n      await guardSecureRoute(authState)\n      return false\n    }\n\n    return true\n  }\n    \n  return true\n}\n\n\nfunction install (app: App, {\n  oktaAuth,\n  onAuthRequired,\n  onAuthResume\n} = {} as OktaVueOptions) {\n  if (!oktaAuth) {\n    throw new AuthSdkError('No oktaAuth instance passed to OktaVue.')\n  }\n\n  const oktaAuthMajorVersion = oktaAuth.userAgent?.split('/')[1]?.split('.')[0];\n  if (oktaAuthMajorVersion && oktaAuthMajorVersion !== process.env.AUTH_JS_MAJOR_VERSION) {\n    throw new AuthSdkError(`\n      Passed in oktaAuth is not compatible with the SDK,\n      okta-auth-js version ${process.env.AUTH_JS_MAJOR_VERSION}.x is the current supported version.\n    `);\n  }\n\n  _oktaAuth = oktaAuth\n  _onAuthRequired = onAuthRequired\n\n  // customize user agent\n  oktaAuth.userAgent = `${PACKAGE.name}/${PACKAGE.version} ${oktaAuth.userAgent}`\n\n  // add default restoreOriginalUri callback\n  if (!oktaAuth.options.restoreOriginalUri) {\n    oktaAuth.options.restoreOriginalUri = async (oktaAuth: OktaAuth, originalUri: string) => {\n      // If a router is available, provide a default implementation\n      if (_router && originalUri) {\n        const path = toRelativeUrl(originalUri, window.location.origin)\n        _router.replace({ path })\n      }\n    }\n  }\n\n  app.mixin({\n    data () {\n      return {\n        authState: oktaAuth.authStateManager.getAuthState()\n      }\n    },\n    beforeCreate () {\n      // assign router for the default restoreOriginalUri callback\n      _router = this.$router\n    },\n    created () {\n      // subscribe to the latest authState\n      oktaAuth.authStateManager.subscribe(this.$_oktaVue_handleAuthStateUpdate)\n      if (!oktaAuth.token.isLoginRedirect()) {\n        // Calculates initial auth state and fires change event for listeners\n        // Also starts the token auto-renew service\n        oktaAuth.start();\n      }\n    },\n    beforeUnmount () {\n      oktaAuth.authStateManager.unsubscribe(this.$_oktaVue_handleAuthStateUpdate)\n      oktaAuth.stop()\n    },\n    // private property naming convention follows\n    // https://vuejs.org/v2/style-guide/#Private-property-names-essential\n    methods: {\n      // eslint-disable-next-line @typescript-eslint/camelcase\n      async $_oktaVue_handleAuthStateUpdate (authState: AuthState) {\n        this.authState = Object.assign(this.authState || {}, authState)\n      }\n    }\n  })\n\n  // add additional options to oktaAuth options\n  Object.assign(oktaAuth.options, {\n    onAuthRequired,\n    onAuthResume\n  })\n\n  // add oktaAuth instance to Vue\n  app.config.globalProperties.$auth = oktaAuth\n}\n\nexport default { install }\n","/*!\n * Copyright (c) 2017-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n\n<script>\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n  name: 'LoginCallback',\n  data() {\n    return {\n      error: null\n    };\n  },\n  async beforeMount () {\n    try {\n      await this.$auth.handleLoginRedirect()\n    } catch (e) {\n      if (this.$auth.isInteractionRequiredError(e)) {\n        const { onAuthResume, onAuthRequired } = this.$auth.options;\n        const callbackFn = onAuthResume || onAuthRequired;\n        if (callbackFn) {\n          callbackFn(this.$auth);\n          return;\n        }\n      }\n      this.error = e.toString();\n    }\n  },\n  render() {\n    return this.error\n  }\n})\n</script>\n"],"names":["AuthSdkError","toRelativeUrl","defineComponent"],"mappings":"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"}